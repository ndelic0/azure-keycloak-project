# azure-keycloak-projectAzure Keycloak Deployment with Terraform and Ansible
This repository contains the infrastructure and application deployment setup for deploying Keycloak on Azure. It uses Terraform to create the infrastructure resources and Ansible for provisioning the Keycloak server and related components, including the Docker setup.

Table of Contents
Overview

Prerequisites

Directory Structure

Usage

Deploying the Infrastructure

Deploying the Application

GitHub Actions

Contributing

License

Overview
This project automates the process of deploying Keycloak on Azure using the following steps:

Provisioning infrastructure with Terraform:

A virtual network, subnet, and public IP are created on Azure.

An Azure virtual machine is provisioned with an SSH key for access.

Setting up Keycloak with Ansible:

Docker is installed on the VM.

Docker Compose is used to deploy Keycloak and a PostgreSQL database.

Keycloak is configured with default credentials.

Prerequisites
Before you can deploy the infrastructure and application, you’ll need to set up the following:

Terraform - Ensure you have Terraform installed. You can download it from Terraform's website.

Ansible - Ansible is required to manage the configuration of the server. Install it via pip:

bash
Copy
Edit
pip install ansible
Azure Subscription - You need an Azure subscription and an associated resource_group_name and resource_group_location. The infrastructure is deployed on this Azure environment.

GitHub Repository Secrets - Set up the required GitHub repository secrets, including any Azure service principal credentials needed for Terraform.

Directory Structure
text
Copy
Edit
azure-keycloak-project/
│
├── ansible/
│   ├── playbooks/
│   │   └── site.yml                  # Main Ansible playbook
│   ├── roles/
│   │   └── keycloak_project/
│   │       ├── tasks/
│   │       │   ├── deploy_containers.yml
│   │       │   └── install_docker.yml
│   │       └── files/
│   │           └── docker-compose.yml
│   └── inventory.ini                 # Dynamic inventory file for Ansible
│
├── terraform/
│   ├── main.tf                       # Terraform configuration for Azure
│   ├── outputs.tf                    # Output configuration for Terraform
│   ├── variables.tf                  # Variables for Terraform configuration
│   └── id_rsa                        # Private SSH key (generated by Terraform)
│
└── .github/
    └── workflows/
        └── deploy.yml                # GitHub Actions workflow file
Usage
Deploying the Infrastructure
To deploy the infrastructure (i.e., the Azure VM, networking resources, etc.), follow these steps:

Clone the repository:

bash
Copy
Edit
git clone https://github.com/yourusername/azure-keycloak-project.git
cd azure-keycloak-project
Initialize Terraform:

bash
Copy
Edit
terraform init
Apply the Terraform configuration to create the Azure resources:

bash
Copy
Edit
terraform apply -auto-approve
After the infrastructure is deployed, Terraform will output the public IP address of the VM.

Deploying the Application
Once the infrastructure is up and running, you can use Ansible to set up Keycloak:

Generate the dynamic Ansible inventory from Terraform output:

bash
Copy
Edit
terraform output -json > terraform_output.json
PUBLIC_IP=$(jq -r '.public_ip.value' terraform_output.json)
echo "[web]" > ansible/inventory.ini
echo "$PUBLIC_IP ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/id_rsa" >> ansible/inventory.ini
Wait for the VM to be ready for SSH:

bash
Copy
Edit
PUBLIC_IP=$(jq -r '.public_ip.value' terraform_output.json)
for i in {1..10}; do
  if ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@$PUBLIC_IP "echo SSH ready"; then
    break
  fi
  sleep 10
done
Run the Ansible playbook to install Docker and deploy Keycloak:

bash
Copy
Edit
ansible-playbook -i ansible/inventory.ini ansible/playbooks/site.yml
Once the playbook runs successfully, Keycloak will be available on the VM. You can access it through http://<VM_Public_IP>:8080.

GitHub Actions
This project includes a GitHub Actions workflow to automate the deployment process when changes are pushed to the main branch:

Deploy Infrastructure: Terraform is used to provision the Azure infrastructure.

Deploy Application: Ansible sets up the Keycloak containers on the VM.

The workflow file .github/workflows/deploy.yml automates the entire process, including:

Checking out the repository.

Initializing and applying Terraform configurations.

Setting up Ansible and running the playbook.

Trigger
The workflow is triggered automatically when code is pushed to the main branch. You can also trigger it manually by opening a pull request or pushing changes.

Contributing
We welcome contributions! If you would like to contribute to this project, please fork the repository, create a new branch, and submit a pull request with your changes.

License
This project is licensed under the MIT License. See the LICENSE file for more information.

This README should be easy to copy and paste. You can further customize or expand it to meet your needs! Let me know if you need any more adjustments.
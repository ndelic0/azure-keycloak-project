# Azure Keycloak Deployment with Terraform and Ansible

This repository contains the infrastructure and application deployment setup for deploying Keycloak on Azure. It uses **Terraform** to create the infrastructure resources and **Ansible** for provisioning the Keycloak server and related components, including the Docker setup.

## Table of Contents

- [Overview](#overview)
- [Prerequisites](#prerequisites)
- [Directory Structure](#directory-structure)
- [Usage](#usage)
  - [Deploying the Infrastructure](#deploying-the-infrastructure)
  - [Deploying the Application](#deploying-the-application)
- [GitHub Actions](#github-actions)
- [Contributing](#contributing)
- [License](#license)

## Overview

This project automates the process of deploying Keycloak on Azure using the following steps:

1. **Provisioning infrastructure with Terraform**:
   - A virtual network, subnet, and public IP are created on Azure.
   - An Azure virtual machine is provisioned with an SSH key for access.

2. **Setting up Keycloak with Ansible**:
   - Docker is installed on the VM.
   - Docker Compose is used to deploy Keycloak and a PostgreSQL database.
   - Keycloak is configured with default credentials.

## Prerequisites

Before you can deploy the infrastructure and application, you’ll need to set up the following:

1. **Terraform** - Ensure you have Terraform installed. You can download it from [Terraform's website](https://www.terraform.io/downloads.html).
2. **Ansible** - Ansible is required to manage the configuration of the server. Install it via pip:
   ```bash
   pip install ansible
   ```
3. **Azure Subscription** - You need an Azure subscription and an associated resource_group_name and resource_group_location. The infrastructure is deployed on this Azure environment.
4. **GitHub Repository Secrets** - Set up the required GitHub repository secrets, including any Azure service principal credentials needed for Terraform.

## Directory Structure
```bash
azure-keycloak-project/
│
├── ansible/
│   ├── playbooks/
│   │   └── site.yml                  # Main Ansible playbook
│   ├── roles/
│   │   └── keycloak_project/
│   │       ├── tasks/
│   │       │   ├── deploy_containers.yml
│   │       │   └── install_docker.yml
│   │       └── files/
│   │           └── docker-compose.yml
│   └── inventory.ini                 # Dynamic inventory file for Ansible
│
├── terraform/
│   ├── main.tf                       # Terraform configuration for Azure
│   ├── outputs.tf                    # Output configuration for Terraform
│   ├── variables.tf                  # Variables for Terraform configuration
│   └── id_rsa                        # Private SSH key (generated by Terraform)
│
└── .github/
    └── workflows/
        └── deploy.yml                # GitHub Actions workflow file
```
## Usage

# Deploying the Infrastructure
To deploy the infrastructure (i.e., the Azure VM, networking resources, etc.), follow these steps:
1. Clone the repository:
   ```bash
   git clone https://github.com/yourusername/azure-keycloak-project.git
   cd azure-keycloak-project
   ```
2. Initialize Terraform:
   ```bash
   terraform init
   ```
3. Apply the Terraform configuration to create the Azure resources:
   ```bash
   terraform apply -auto-approve
   ```
4. After the infrastructure is deployed, Terraform will output the public IP address of the VM.

# Deploying the Application
Once the infrastructure is up and running, you can use Ansible to set up Keycloak:
1. Generate the dynamic Ansible inventory from Terraform output:
```bash
terraform output -json > terraform_output.json
PUBLIC_IP=$(jq -r '.public_ip.value' terraform_output.json)
echo "[web]" > ansible/inventory.ini
echo "$PUBLIC_IP ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/id_rsa" >> ansible/inventory.ini
```
2. Wait for the VM to be ready for SSH:
```bash
PUBLIC_IP=$(jq -r '.public_ip.value' terraform_output.json)
for i in {1..10}; do
  if ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ubuntu@$PUBLIC_IP "echo SSH ready"; then
    break
  fi
  sleep 10
done
```
3. Run the Ansible playbook to install Docker and deploy Keycloak:
```bash
ansible-playbook -i ansible/inventory.ini ansible/playbooks/site.yml
```
Once the playbook runs successfully, Keycloak will be available on the VM. You can access it through http://<VM_Public_IP>:8080.

# GitHub Actions
This project includes a GitHub Actions workflow to automate the deployment process when changes are pushed to the main branch:
- Deploy Infrastructure: Terraform is used to provision the Azure infrastructure.
- Deploy Application: Ansible sets up the Keycloak containers on the VM.

The workflow file .github/workflows/deploy.yml automates the entire process, including:
1. Checking out the repository.
2. Initializing and applying Terraform configurations.
3. Setting up Ansible and running the playbook.

# Trigger
The workflow is triggered automatically when code is pushed to the main branch. You can also trigger it manually by opening a pull request or pushing changes.

